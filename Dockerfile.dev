FROM ruby:3.3.0-slim

# Install build dependencies
RUN apt-get update && \
  apt-get install -y --no-install-recommends \
  build-essential \
  libpq-dev \
  git \
  && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy all files
COPY . .

# Initialize git repo to suppress "not a git repository" warning
RUN git init && \
  git add . && \
  git config user.email "docker@pg-osc.local" && \
  git config user.name "Docker Build" && \
  git commit -m "Docker build" 2>/dev/null || true

# Build and install the gem globally
RUN gem build pg_online_schema_change.gemspec && \
  gem install pg_online_schema_change-*.gem && \
  rm -f pg_online_schema_change-*.gem

# Set the entrypoint to the installed gem binary
ENTRYPOINT ["pg-online-schema-change"]
CMD ["--help"]
